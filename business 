<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Growth Link Sharer</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-field {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* Blue 500 */
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .link-item:hover {
            background-color: #f1f5f9;
        }
        .service-icon {
            width: 24px;
            height: 24px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firestore
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOM elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const toggleAuthBtn = document.getElementById('toggle-auth-mode');
        const addLinkForm = document.getElementById('add-link-form');
        const linksList = document.getElementById('links-list');
        const userStatus = document.getElementById('user-status');
        const signOutBtn = document.getElementById('sign-out-btn');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        let isLoginMode = true;

        // --- Utility Functions ---

        /**
         * Shows a temporary message box for alerts/errors.
         * @param {string} message - The message to display.
         * @param {boolean} isError - If true, styles the box as an error.
         */
        const showMessage = (message, isError = false) => {
            messageText.textContent = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-800' : 'text-green-800');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        };

        /**
         * Clears all forms in the application.
         */
        const clearForms = () => {
            loginForm.reset();
            registerForm.reset();
            addLinkForm.reset();
        };

        // --- Authentication Logic ---

        /**
         * Handles user login with email and password.
         * @param {Event} e - The form submission event.
         */
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('Login successful! Welcome back.');
                clearForms();
            } catch (error) {
                console.error("Login Error:", error);
                showMessage(`Login Failed: ${error.message.replace('Firebase: Error ', '')}`, true);
            }
        });

        /**
         * Handles user registration with email and password.
         * @param {Event} e - The form submission event.
         */
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerForm.email.value;
            const password = registerForm.password.value;

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage('Registration successful! You are now logged in.');
                clearForms();
                isLoginMode = true; // Switch to login view after successful registration (though onAuthStateChanged handles UI)
            } catch (error) {
                console.error("Registration Error:", error);
                showMessage(`Registration Failed: ${error.message.replace('Firebase: Error ', '')}`, true);
            }
        });

        /**
         * Toggles between the login and registration forms.
         */
        toggleAuthBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            if (isLoginMode) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                toggleAuthBtn.textContent = "New user? Register Here";
                document.getElementById('auth-title').textContent = "Sign In to Access Links";
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                toggleAuthBtn.textContent = "Existing user? Sign In";
                document.getElementById('auth-title').textContent = "Create New Account";
            }
        });

        /**
         * Handles user sign out.
         */
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage('You have been signed out.');
            } catch (error) {
                console.error("Sign Out Error:", error);
                showMessage('Failed to sign out.', true);
            }
        });

        // Initial sign-in attempt using the environment token
        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => {
                console.warn("Custom Token Sign-In failed, falling back to anonymous or manual:", error);
                // If custom token fails, proceed to check auth state which will show the login screen if needed.
            });
        } else {
            // Sign in anonymously if no token is available to establish a base session for Firestore rules.
            signInAnonymously(auth).catch(error => {
                console.error("Anonymous Sign-In failed:", error);
            });
        }

        // --- Firestore Logic and Real-time Updates ---

        /**
         * Collection reference for public video links.
         */
        const getLinksCollectionRef = () => {
            return collection(db, `artifacts/${appId}/public/data/video_links`);
        }

        /**
         * Adds a new video link to the Firestore database.
         * @param {Event} e - The form submission event.
         */
        addLinkForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = addLinkForm.link_url.value.trim();
            const description = addLinkForm.link_description.value.trim();
            const user = auth.currentUser;

            if (!user) {
                showMessage("You must be logged in to share a link.", true);
                return;
            }
            if (!url || !description) {
                showMessage("Please fill in both the URL and description.", true);
                return;
            }

            // Simple validation and extraction of service
            let service = 'General';
            if (url.includes('youtube.com') || url.includes('youtu.be')) service = 'YouTube';
            else if (url.includes('tiktok.com')) service = 'TikTok';
            else if (url.includes('instagram.com')) service = 'Instagram';

            try {
                await addDoc(getLinksCollectionRef(), {
                    url: url,
                    description: description,
                    service: service,
                    userId: user.uid,
                    userName: user.email || 'Anonymous',
                    timestamp: serverTimestamp(),
                });
                showMessage('Link shared successfully!');
                addLinkForm.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage(`Failed to share link: ${error.message}`, true);
            }
        });

        /**
         * Renders the list of links to the DOM.
         * @param {Array<Object>} links - Array of link objects from Firestore.
         */
        const renderLinks = (links) => {
            linksList.innerHTML = ''; // Clear existing links
            
            if (links.length === 0) {
                linksList.innerHTML = '<p class="text-gray-500 p-4">No links shared yet. Be the first!</p>';
                return;
            }

            // Sort links by timestamp (most recent first)
            links.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            links.forEach(link => {
                // Determine icon based on service
                let iconHtml;
                let colorClass;
                switch (link.service) {
                    case 'YouTube':
                        iconHtml = '<svg class="service-icon fill-current text-red-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M549.655 124.083c-6.281-23.65-24.787-42.207-48.497-48.498C490.113 64 288 64 288 64S85.888 64 74.832 75.586c-23.709 6.291-42.215 24.848-48.496 48.498C16 160 16 256 16 256s0 96 10.832 131.917c6.281 23.65 24.787 42.207 48.497 48.498C85.888 448 288 448 288 448s202.112 0 213.168-11.586c23.709-6.291 42.215-24.848 48.496-48.498C560 352 560 256 560 256s0-96-10.345-131.917zM232 352V160l144 96-144 96z"/></svg>';
                        colorClass = 'text-red-600';
                        break;
                    case 'TikTok':
                        iconHtml = '<svg class="service-icon fill-current text-black dark:text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M448 290.019C448 402.019 367.314 448 259.314 448c-18.49 0-37.037-1.397-55.378-4.223 27.288-51.196 37.585-110.155 37.585-132.899 0-14.776-5.842-20.08-11.758-20.08h-63.55c-11.875 0-23.738 7.351-28.537 19.866-22.118 56.242-49.813 103.771-105.748 103.771-16.17 0-33.024-4.881-44.577-12.868 2.053-1.636 3.993-3.321 5.864-5.068 3.018-2.827 5.923-5.741 8.685-8.732 1.954-2.147 3.791-4.348 5.485-6.602 1.341-1.742 2.627-3.535 3.843-5.385.748-1.092 1.48-2.193 2.185-3.308C87.489 321.498 111.411 289.431 111.411 251.644c0-26.697-8.157-52.016-24.116-73.805-2.071-2.836-3.882-5.918-5.399-9.155-2.138-4.664-3.619-9.529-4.373-14.545-2.278-14.993-1.252-30.825 3.208-45.748 7.378-24.385 24.228-44.808 45.421-59.204 1.258-.847 2.607-1.659 4.029-2.427 1.464-.789 2.981-1.543 4.54-2.261 2.308-1.074 4.673-2.072 7.086-3.003 4.697-1.849 9.539-3.529 14.509-4.993 1.353-.399 2.709-.791 4.067-1.183 2.453-.717 4.939-1.393 7.452-2.01 1.761-.433 3.529-.844 5.302-1.228 1.905-.411 3.816-.8 5.733-1.157 2.02-.387 4.049-.757 6.084-1.11 3.125-.536 6.262-1.042 9.407-1.516 4.316-.653 8.647-1.25 12.989-1.802 2.336-.297 4.679-.58 7.027-.853 2.502-.294 5.01-.577 7.518-.846 1.715-.183 3.435-.357 5.155-.521 1.93-.184 3.864-.356 5.803-.515 2.56-.214 5.123-.418 7.69-.607 1.884-.139 3.771-.274 5.66-.401 2.41-.165 4.825-.323 7.243-.467 1.472-.089 2.946-.174 4.421-.257 2.219-.126 4.44-.247 6.663-.356 1.155-.057 2.311-.113 3.468-.168C274.887 64 330.419 64 380.125 64c78.889 0 102.378 17.589 102.378 77.632 0 32.744-19.166 49.349-36.945 62.067-13.064 9.15-28.718 16.918-46.069 22.923-16.142 5.568-35.333 9.407-57.575 9.407-1.745 0-3.486-.07-5.226-.208 40.528 27.972 58.742 71.327 58.742 124.018z"/></svg>';
                        colorClass = 'text-black'; // Black icon is standard for TikTok
                        break;
                    case 'Instagram':
                        iconHtml = '<svg class="service-icon fill-current text-pink-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M224.1 123.6c-42.6 0-77.4 34.9-77.4 77.5 0 42.5 34.8 77.3 77.4 77.3s77.4-34.9 77.4-77.5-34.8-77.3-77.4-77.3zm-119.8 2.6H84.2c-5.5 0-9.9 4.4-9.9 9.9v15.2c0 5.5 4.4 9.9 9.9 9.9h20.2c5.5 0 9.9-4.4 9.9-9.9v-15.2c0-5.5-4.4-9.9-9.9-9.9zm270.8 2.6h-20.2c-5.5 0-9.9 4.4-9.9 9.9v15.2c0 5.5 4.4 9.9 9.9 9.9h20.2c5.5 0 9.9-4.4 9.9-9.9v-15.2c0-5.5-4.4-9.9-9.9-9.9zM224.1 411.3c-74.9 0-136.1-61.2-136.1-136.1 0-41.5 18.6-78.2 47.9-102.7 4.2-3.6 5.6-9.6 4-15.4-.6-2.3-1.1-4.7-1.1-7.1 0-14.8 12-26.8 26.8-26.8h20.2c14.8 0 26.8 12 26.8 26.8 0 2.4-.5 4.8-1.1 7.1-1.6 5.8-.2 11.8 4 15.4 29.3 24.5 47.9 61.2 47.9 102.7s-61.2 136.1-136.1 136.1zM448 108.8v294.4c0 29.9-24.3 54.2-54.2 54.2H54.2C24.3 457.4 0 433.1 0 403.2V108.8C0 78.9 24.3 54.6 54.2 54.6h339.6c29.9 0 54.2 24.3 54.2 54.2z"/></svg>';
                        colorClass = 'text-pink-600';
                        break;
                    default:
                        iconHtml = '<svg class="service-icon text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M352 320L352 48l80 0 0 272-80 0zm-80 0L272 160l80 0 0 160-80 0zM192 320L192 0 272 0 272 320 192 320zm-80 0L112 96l80 0 0 224-80 0zM32 320L32 192l80 0 0 128-80 0zM400 352L400 512 112 512 112 352 400 352z"/></svg>'; // Generic link icon
                        colorClass = 'text-gray-500';
                }
                
                // Format timestamp
                const date = link.timestamp ? new Date(link.timestamp.seconds * 1000).toLocaleString() : 'Just now';

                const linkElement = document.createElement('div');
                linkElement.className = 'link-item p-4 flex items-start space-x-4 border-b border-gray-100 transition duration-150 ease-in-out';
                linkElement.innerHTML = `
                    <div class="flex-shrink-0 pt-1">
                        ${iconHtml}
                    </div>
                    <div class="flex-grow min-w-0">
                        <a href="${link.url}" target="_blank" class="text-lg font-semibold ${colorClass} hover:underline break-words" rel="noopener noreferrer">
                            ${link.description}
                        </a>
                        <p class="text-sm text-gray-600 truncate mt-1">
                            <span class="font-mono text-xs text-gray-400">${link.url}</span>
                        </p>
                        <p class="text-xs text-gray-400 mt-2">
                            Shared by: <span class="font-medium text-gray-700">${link.userName.split('@')[0]}</span> on ${date}
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                         <a href="${link.url}" target="_blank" class="text-xs font-semibold py-1 px-3 rounded-full border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white transition duration-200" rel="noopener noreferrer">
                            Go & Like!
                        </a>
                    </div>
                `;
                linksList.appendChild(linkElement);
            });
        }

        // Real-time listener for links
        let unsubscribe = null;

        /**
         * Sets up the real-time Firestore listener, runs only after successful authentication.
         */
        const setupLinkListener = () => {
            if (unsubscribe) {
                unsubscribe(); // Detach previous listener if it exists
            }

            const linksQuery = query(getLinksCollectionRef());

            unsubscribe = onSnapshot(linksQuery, (snapshot) => {
                const links = [];
                snapshot.forEach((doc) => {
                    links.push({ id: doc.id, ...doc.data() });
                });
                renderLinks(links);
            }, (error) => {
                console.error("Firestore listen failed:", error);
                showMessage("Failed to load links from the database.", true);
            });
        }

        // --- Main App Flow: Auth State Observer ---

        onAuthStateChanged(auth, (user) => {
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.add('hidden');

            if (user && user.email) {
                // User is signed in with email/password
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userStatus.textContent = `User: ${user.email} (ID: ${user.uid})`;
                setupLinkListener(); // Start listening for data
            } else if (user) {
                 // User is signed in anonymously (from initial load, or if the initial token didn't have email)
                 // Still force them to use the primary login/register UI for the required functionality
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                userStatus.textContent = '';
                if (unsubscribe) unsubscribe();
            }
            else {
                // User is signed out or anonymous session requires upgrade
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                userStatus.textContent = '';
                if (unsubscribe) unsubscribe();
            }
        });

    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Message Box (Alert/Error) -->
    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg hidden shadow-xl z-50 transition duration-300">
        <p id="message-text" class="text-sm font-medium"></p>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="flex flex-col items-center justify-center p-8">
        <div class="loading-spinner"></div>
        <p class="mt-4 text-gray-600">Initializing App...</p>
    </div>

    <!-- Authentication Container -->
    <div id="auth-container" class="w-full max-w-md hidden">
        <div class="card p-8 space-y-6">
            <h2 id="auth-title" class="text-3xl font-bold text-gray-800 text-center">Sign In to Access Links</h2>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <input type="email" name="email" placeholder="Email" class="input-field" required>
                <input type="password" name="password" placeholder="Password" class="input-field" required>
                <button type="submit" class="btn-primary w-full">Sign In</button>
            </form>

            <!-- Registration Form (Hidden by default) -->
            <form id="register-form" class="space-y-4 hidden">
                <input type="email" name="email" placeholder="Email" class="input-field" required>
                <input type="password" name="password" placeholder="Password (min 6 characters)" class="input-field" required minlength="6">
                <button type="submit" class="btn-primary w-full">Register</button>
            </form>

            <div class="text-center">
                <button id="toggle-auth-mode" class="text-sm text-blue-500 hover:text-blue-700 transition duration-150">New user? Register Here</button>
            </div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-4xl hidden space-y-6">
        
        <!-- Header and User Status -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-white card">
            <h1 class="text-2xl font-bold text-gray-800">Video Link Booster</h1>
            <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                <p id="user-status" class="text-sm text-gray-600"></p>
                <button id="sign-out-btn" class="text-sm text-red-500 hover:text-red-700 transition duration-150 font-medium">Sign Out</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Link Submission Panel -->
            <div class="lg:col-span-1 card p-6 h-fit">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Share a New Video Link</h2>
                <form id="add-link-form" class="space-y-4">
                    <label class="block">
                        <span class="text-sm font-medium text-gray-700">Video URL (TikTok, YouTube, Instagram, etc.)</span>
                        <input type="url" name="link_url" placeholder="https://tiktok.com/@user/video/..." class="input-field mt-1" required>
                    </label>
                    <label class="block">
                        <span class="text-sm font-medium text-gray-700">Short Description / Goal (e.g., "Need 100 Likes on my latest YouTube short")</span>
                        <textarea name="link_description" placeholder="A brief description of your video and why friends should check it out." class="input-field mt-1 h-20 resize-none" required></textarea>
                    </label>
                    <button type="submit" class="btn-primary w-full">Add Link to Board</button>
                </form>
            </div>

            <!-- Links List Panel -->
            <div class="lg:col-span-2 card p-0 overflow-hidden">
                <div class="bg-blue-50 p-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Active Links Waiting for Support</h2>
                    <p class="text-sm text-gray-600 mt-1">Click "Go & Like!" to visit the video and boost your friend's account.</p>
                </div>
                <!-- Links will be dynamically inserted here -->
                <div id="links-list" class="divide-y divide-gray-100 max-h-[60vh] overflow-y-auto">
                    <p class="text-gray-500 p-4 text-center">Loading shared links...</p>
                </div>
            </div>
        </div>
    </div>

</body>
</html>